---
title: "Pacific Maritime Big Book of Bees"
---

```{r include = F}
knitr::opts_chunk$set(echo = F, warning=F, message=F)

library(plotly)
library(tidyverse)
library(googlesheets4)

# spreadsheet data
gs4_auth('galiwatch.info@gmail.com')
df <- read_sheet("1c4N54O_x8a_Wfoe3tct0gryId2wG0ze-HA-Ckms4dy4", sheet = 'Bee families of BC') 

# gbif data


gbif <- do.call(bind_rows, lapply(paste0("files/", list.files(path="files", pattern="*231120084113126.csv")), read_delim, delim="\t")) %>%
  mutate(date = ymd(date(eventDate)), Year = year(date),
         Month = lubridate::month(date, label=T),
         lat=decimalLatitude, lon=decimalLongitude) %>%
  drop_na(date, lat, lon, genus, occurrenceID) %>%
  separate_wider_delim(species, ' ', names=c('Genus', 'Species'), too_many = 'merge')
```

Big Book of Bees!  

This book features annotations of bees of the PNW. Images have been collected from [iNaturalist](https://www.inaturalist.org/), and special thanks to [Spencer Collection](https://www.zoology.ubc.ca/entomology/) for allowing us to reproduce their specimen images as references for this book

How to use: 

* Look up your favourite species in the gallery
* Compare with your own observations to help identify beess
* Click any image to be taken to the database source

Bees are organized by genus. 

# Data Completeness

Bee book gallery shows two pieces of info per species page: 

1. bee image (curated by KQ)
2. observation map (pulled from GBIF)

Page completeness is as follows:

```{r}
upset_list = list(`Has GBIF map` = unique(gbif$Species),
                  `In bee gallery` = unique(df$Species), 
                  `Has image` =unique(df$Species[!is.na(df$`Image link`)])
)

UpSetR::upset(UpSetR::fromList(upset_list))

```

# Genus coverage

```{r}
gbif %>%
  filter(!is.na(Species)) %>%
  group_by(family) %>% 
  summarize(n=n()) %>%
  ggplot(aes(x = reorder(family, n), y = n, fill=family)) + 
  geom_bar(sta='identity') +
  ggpubr::theme_pubr() +
  coord_flip() + 
  #scale_fill_brewer(palette = "Paired") + 
  ggpubr::yscale("log10", .format = TRUE) + 
  labs(x = 'Family', y = 'Number of Observations in GBIF') +
  theme(legend.position = 'None')

```

```{r, out.height='100%', out.width='100%', fig.height=6}
df %>%
  filter(!is.na(Species)) %>%
  group_by(Family) %>% 
  summarize(n=n()) %>%
  ggplot(aes(x = reorder(Family, n), y = n, fill=Family)) +
  geom_bar(sta='identity') +
  ggpubr::theme_pubr() +
  coord_flip() + 
  ggpubr::yscale("log10", .format = TRUE) + 
  labs(x = 'Family', y = 'Number of Species in Gallery') + 
  theme(legend.position = 'None')

```

# Observations map

This map shows observations from [GBIF](https://www.gbif.org/) for family Apidae. [Downloaded Nov 23 2023](https://doi.org/10.15468/dl.8bqmte). 

Double click any genus to isolate it on the map. 



```{r}
map_plot <- function(df){
  df %>%
    filter(!is.na(Species))%>%
    mutate(Year=ifelse(Year<2015, 'Before 2015', Year)) %>%
  mutate(Year = ordered(Year, levels = c('Before 2015', 2015:2023))) %>%
  complete(Year, Genus) %>%
  plot_ly() %>%
  add_trace(
    lat = ~lat, lon =~lon,
    mode = 'markers', type = 'scattermapbox',
    frame= ~Year,
    color = ~Genus,
    text = ~paste('Species:', Genus, Species, '\nObserved:', stamp("March 1, 1999")(date)),
    size=10,
    colors='Paired'
  ) %>%
  layout(mapbox = list(
    style = 'carto-positron', show_legend = T,
    #zoom=7, center = list(lon = -123, lat = 49)))
    zoom=3.5, center = list(lon = -127, lat = 53)),
    title = 'GBIF observations') %>%
    return()
}
```

::: {.panel-tabset}

## Andrenidae

```{r}
gbif %>%
  filter(family == 'Andrenidae') %>%
  map_plot()
```

## Apidae

```{r}
gbif %>%
  filter(family == 'Apidae') %>%
  map_plot()
```

## Colletidae

```{r}
gbif %>%
  filter(family == 'Colletidae') %>%
  map_plot()
```

## Halictidae

```{r}
gbif %>%
  filter(family == 'Halictidae') %>%
  map_plot()
```

## Megachilidae

```{r}
gbif %>%
  filter(family == 'Megachilidae') %>%
  map_plot()
```

## Melittidae

```{r}
gbif %>%
  filter(family == 'Melittidae') %>%
  map_plot()
```
:::


```{r, include=F}
gbif %>%
  filter(family == 'Apidae') %>%
  filter(!is.na(Species))%>%
  mutate(Year=ifelse(Year<2015, 'Before 2015', Year)) %>%
  mutate(Year = ordered(Year, levels = c('Before 2015', 2015:2023))) %>%
  complete(Year, Genus) %>%
  plot_ly() %>%
  add_trace(
    lat = ~lat, lon =~lon,
    mode = 'markers', type = 'scattermapbox',
    frame=~Year,
    color = ~Genus,
    text = ~paste('Species:', Genus, Species, '\nObserved:', stamp("March 1, 1999")(date)),
    size=10,
    colors='Paired'
  ) %>%
  layout(mapbox = list(
    style = 'carto-positron', show_legend = T,
    #zoom=7, center = list(lon = -123, lat = 49)))
    zoom=3.8, center = list(lon = -127, lat = 55)),
    title = 'GBIF observations') 

```




# Summary of Andrena information

**Kingdom: Animalia; Phylum: Arthropoda; Class Hymenoptera; Superfamily: Apoidea; Family: Andrenidae**

52 species listed by Shefield and Heron (2018) including 11 with verified iNaturalist records plus one additional iNaturalist record of Andrena astragali (death camas mining bee) that was first documented in the Pacific Maritime in 2018.

When available, species information will be displayed with the following priority: 

1. Verified on iNaturalist, and seen in Pacific Maritime
1. Verified on iNaturalist, and seen outside of the Pacific Maritime 
1. Specimen available in the UBC [Spencer Entomological Collection](https://www.zoology.ubc.ca/entomology/)
1. Species listed on the [Shefield and Heron List](https://journal.entsocbc.ca/index.php/journal/article/view/1001), but not otherwise observed

The Pacific Maritime has 53 documented species of Andrena.

```{r}
tibble(source=c('Verified iNat - PM', 'Verified iNat - other', 'Spencer collection', 'Shefield and Heron List'), n = c(12, 12, 18, 11)) %>%
  ggplot(aes(x=reorder(source,n), y=n, fill=source)) + 
  geom_bar(stat='identity', show.legend = F) + 
  ggpubr::theme_pubr() + 
  coord_flip() + 
  labs(x = 'Source', y = 'Number of species')

```

